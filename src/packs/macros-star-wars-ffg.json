[
  {
    "_id": "star-wars-ffg-damage-calculator-macro",
    "name": "Damage Calculator",
    "type": "script",
    "scope": "global",
    "author": "OYHypgZ1SlP5M1vq",
    "img": "icons/svg/dice-target.svg",
    "command": "const getLastAttackFromChat = (actor) => {\n  const attackKeywords = ['RangedHeavy', 'RangedLight', 'Melee', 'Lightsaber', 'Gunnery', 'Brawl']\n\n  const chatMessages = game.messages.contents.reverse()\n\n  const lastAttackMessage = chatMessages.find(\n    (message) =>\n      attackKeywords.some((keyword) => message.flavor.replace(/[:\\s]/g, '').includes(keyword)) && message.rolls.length && message.rolls[0].data.type === 'weapon' && message.speaker.actor === actor.id\n  )\n\n  const attackerActorId = lastAttackMessage.speaker.actor\n\n  const attacker = game.actors.get(attackerActorId)\n\n  return { lastAttackMessage, attacker }\n}\n\nconst getActorStats = (actor) => ({\n  soak: actor.system.stats.soak.value,\n  wounds: actor.system.stats.wounds.value,\n  maxWounds: actor.system.stats.wounds.max,\n  strain: actor.system.stats.strain.value,\n  maxStrain: actor.system.stats.strain.max,\n})\n\nconst getWeaponModifiers = (weapon) => {\n  const pierce = weapon.system.itemmodifier.find((modifier) => modifier.name.toLowerCase().includes('pierce'))\n  const breach = weapon.system.itemmodifier.find((modifier) => modifier.name.toLowerCase().includes('breach'))\n  const stun = weapon.system.itemmodifier.find((modifier) => modifier.name.toLowerCase().includes('stun damage'))\n\n  return {\n    pierce: pierce ? pierce.system.rank : 0,\n    breach: breach ? breach.system.rank * 10 : 0,\n    strainDamage: !!stun,\n  }\n}\n\nconst calculateDamage = async () => {\n  const { lastAttackMessage, attacker } = getLastAttackFromChat(actor)\n\n  if (!attacker) {\n    ui.notifications.error('No token found.')\n    return\n  }\n\n  const attackerName = lastAttackMessage.speaker.alias\n\n  const success = lastAttackMessage.rolls[0].ffg.success\n\n  if (!success) {\n    await ChatMessage.create({\n      user: game.user._id,\n      speaker: ChatMessage.getSpeaker(),\n      content: `${attackerName} misses ${target.name}.`,\n    })\n    return\n  }\n\n  const targets = lastAttackMessage.user.targets\n\n  if (!targets.size) {\n    ui.notifications.info('No tokens targeted.')\n    return\n  }\n\n  const target = await canvas.tokens.get(targets.ids[0])\n\n  const targetStats = getActorStats(target.actor)\n\n  const weapon = lastAttackMessage.rolls[0].data\n  const weaponModifiers = getWeaponModifiers(weapon)\n\n  const soakAfterModifiers = targetStats.soak - (weaponModifiers.pierce + weaponModifiers.breach)\n  const remainingSoak = soakAfterModifiers < 0 ? 0 : soakAfterModifiers\n\n  const baseDamage = weapon.system.damage.adjusted || weapon.system.damage.value\n  const extraDamage = success\n  const totalDamage = baseDamage + extraDamage\n  const damageAfterSoak = totalDamage - remainingSoak\n\n  const damageType = weaponModifiers.strainDamage ? 'strain' : 'wounds'\n  const currentStat = damageType === 'strain' ? targetStats.strain : targetStats.wounds\n  const maxStat = damageType === 'strain' ? targetStats.maxStrain : targetStats.maxWounds\n\n  if (damageAfterSoak > 0) {\n    await target.actor.update({ [`system.stats.${damageType}.value`]: currentStat + damageAfterSoak })\n  }\n\n  let chatMessage = `${attackerName} hits ${target.name} with ${weapon.name} for ${totalDamage} ${damageType === 'strain' ? 'strain' : ''} damage.`\n\n  if (currentStat + damageAfterSoak > maxStat) {\n    chatMessage += ` ${target.name} is incapacitated.`\n  }\n\n  await ChatMessage.create({\n    user: game.user._id,\n    speaker: ChatMessage.getSpeaker(),\n    content: chatMessage,\n  })\n}\n\ncalculateDamage()",
    "folder": null,
    "flags": {
      "condition-lab-triggler": {
        "macroTrigger": ""
      },
      "exportSource": {
        "world": "mask-of-the-pirate-queen",
        "system": "starwarsffg",
        "coreVersion": "11.315",
        "systemVersion": "1.809"
      }
    },
    "_stats": {
      "systemId": "starwarsffg",
      "systemVersion": "1.809",
      "coreVersion": "11.315",
      "createdTime": 1746295701976,
      "modifiedTime": 1746295707412,
      "lastModifiedBy": "OYHypgZ1SlP5M1vq"
    }
  }
]
